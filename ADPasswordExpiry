# Import the Active Directory module
Import-Module ActiveDirectory

# Define output CSV file path
$outputFile = "C:\temp\ES_AD_Accounts_PasswordAge.csv"

# Get all user accounts from Active Directory
$users = Get-ADUser -Filter * -Property DisplayName, SamAccountName, PasswordLastSet

# Create an array to store user information
$result = @()

foreach ($user in $users) {
    # Calculate the password age in days
    if ($user.PasswordLastSet -ne $null) {
        $passwordAge = (Get-Date) - $user.PasswordLastSet
    } else {
        $passwordAge = "Never Set"
    }

    # Add user information to the result array
    $result += [PSCustomObject]@{
        DisplayName       = $user.DisplayName
        SamAccountName    = $user.SamAccountName
        PasswordLastSet   = $user.PasswordLastSet
        PasswordAgeInDays = if ($passwordAge -ne "Never Set") { [math]::Floor($passwordAge.TotalDays) } else { "Never Set" }
    }
}

# Export the result to CSV
$result | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8

Write-Host "Export completed. File saved to $outputFile"





# Import the Active Directory module (if not already imported)
Import-Module ActiveDirectory

# Path to the CSV file
$csvPath = "C:\temp\pswexpiresnov2024.csv"

# Import the CSV file
$users = Import-Csv -Path $csvPath

# Loop through each user in the CSV file
foreach ($user in $users) {
    # Directly set PasswordNeverExpires to False for each user in the CSV
    Set-ADUser -Identity $user.SamAccountName -PasswordNeverExpires $false
    Write-Output "Set PasswordNeverExpires to False for user: $($user.SamAccountName)"
}
